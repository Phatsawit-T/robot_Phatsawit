/*
 * Test Automation Assignment - Question 5: Jenkins Pipeline for Executing Automated Scripts
 *
 * This Jenkins Pipeline automates the execution of Robot Framework test scripts
 * covering Web, API, and Mobile test automation.
 *
 * Pipeline Stages:
 * 1. Checkout Code From Git  - Pull latest code from GitHub repository
 * 2. Install Dependencies    - Install Python packages and Robot Framework libraries
 * 3. Run Tests in Parallel   - Execute Web, API, and Mobile tests concurrently
 * 4. Publish Test Results    - Archive test results and generate Robot Framework reports
 * 5. Generate Test Report    - Create consolidated test report from all test suites
 *
 * Parameters:
 * - RUN_MOBILE_TESTS: Enable/disable mobile test execution (requires Appium server)
 * - TEST_SUITE: Select which test suite to run (ALL/WEB/API/MOBILE)
 * - TAGS: Filter tests by Robot Framework tags (e.g., Smoke, P0, P1)
 *
 * Repository: https://github.com/Phatsawit-T/robot_Phatsawit.git
 */

pipeline {
    agent any
    
    environment {
        REPO_URL = 'https://github.com/Phatsawit-T/robot_Phatsawit.git'
        RESULTS_DIR = "results/${BUILD_TIMESTAMP}"
        SCRIPTS_DIR = 'src/scripts'
        REQUIREMENTS_FILE = 'requirements.txt'
        PYTHON_VERSION = '3.10'
        BUILD_TIMESTAMP = new Date().format('yyyy-MM-dd_HH-mm-ss')
    }
    
    stages {
        stage('Checkout Code From Git') {
            steps {
                echo "Checking out code from ${REPO_URL}"
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                echo "Installing Python dependencies"
                bat """
                    python --version
                    pip install --upgrade pip
                    pip install -r ${REQUIREMENTS_FILE}
                """
            }
        }
        
        stage('Run Tests') {
            steps {
                echo "Running Robot Framework Tests"
                script {
                    def testFiles = []
                    def tagOption = params.TAGS ? "--include ${params.TAGS}" : ""
                    
                    // กำหนด test files ตาม TEST_SUITE parameter
                    switch(params.TEST_SUITE) {
                        case 'WEB':
                            testFiles.add("${SCRIPTS_DIR}/login_test_web.robot")
                            break
                        case 'API':
                            testFiles.add("${SCRIPTS_DIR}/api_testing.robot")
                            break
                        case 'MOBILE':
                            if (params.RUN_MOBILE_TESTS) {
                                testFiles.add("${SCRIPTS_DIR}/mobile_testing.robot")
                            } else {
                                echo "Mobile tests are disabled"
                            }
                            break
                        case 'ALL':
                        default:
                            testFiles.add("${SCRIPTS_DIR}/login_test_web.robot")
                            testFiles.add("${SCRIPTS_DIR}/api_testing.robot")
                            if (params.RUN_MOBILE_TESTS) {
                                testFiles.add("${SCRIPTS_DIR}/mobile_testing.robot")
                            }
                            break
                    }
                    
                    if (testFiles.size() > 0) {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            bat """
                                robot --name "Automated Test Report" ${tagOption} --outputdir ${RESULTS_DIR} ${testFiles.join(' ')}
                            """
                        }
                    } else {
                        echo "No test files to execute"
                    }
                }
            }
        }
        
        stage('Publish Test Results') {
            steps {
                echo "Publishing test results"
                script {
                    // Archive test results
                    archiveArtifacts artifacts: "${RESULTS_DIR}/**/*.html, ${RESULTS_DIR}/**/*.xml", 
                                   allowEmptyArchive: true
                }
            }
        }
    }
    
    post {
        always {
            echo "Pipeline execution completed"
        }
        success {
            echo "✅ All tests passed successfully!"
        }
        failure {
            echo "❌ Some tests failed. Check the results."
        }
        unstable {
            echo "⚠️ Tests completed with warnings or some failures."
        }
    }
}

// Pipeline Parameters
properties([
    parameters([
        booleanParam(
            name: 'RUN_MOBILE_TESTS', 
            defaultValue: true, 
            description: 'Run mobile tests (requires Appium server)'
        ),
        choice(
            name: 'TEST_SUITE', 
            choices: ['ALL', 'WEB', 'API', 'MOBILE'], 
            description: 'Select test suite to run'
        ),
        string(
            name: 'TAGS', 
            defaultValue: '', 
            description: 'Robot Framework tags to filter tests (e.g., Smoke, P0)'
        )
    ])
])