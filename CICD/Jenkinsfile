/*
 * Test Automation Assignment - Question 5: Jenkins Pipeline for Executing Automated Scripts
 *
 * This Jenkins Pipeline automates the execution of Robot Framework test scripts
 * covering Web, API, and Mobile test automation.
 *
 * Pipeline Stages:
 * 1. Checkout Code From Git  - Pull latest code from GitHub repository
 * 2. Run Tests              - Execute selected test suites
 * 3. Publish Test Results   - Archive test results and reports
 *
 * Parameters:
 * - RUN_MOBILE_TESTS: Enable/disable mobile test execution (requires Appium server)
 * - RUN_WEB_TESTS: Enable/disable web login tests
 * - RUN_API_TESTS: Enable/disable API tests
 * - RUN_CAESAR_CIPHER_DECRYPTION: Enable/disable Caesar Cipher tests
 * - RUN_CHECK_DUPLICATE: Enable/disable check duplicate tests
 * - TAGS: Filter tests by Robot Framework tags (e.g., Smoke, P0, P1)
 *
 * Repository: https://github.com/Phatsawit-T/robot_Phatsawit.git
 */

pipeline {
    agent any
    
    parameters {
        booleanParam(
            name: 'RUN_MOBILE_TESTS', 
            defaultValue: false, 
            description: 'Run mobile tests (requires Appium server)'
        )
        booleanParam(
            name: 'RUN_WEB_TESTS', 
            defaultValue: true, 
            description: 'Run login test web'
        )
        booleanParam(
            name: 'RUN_API_TESTS', 
            defaultValue: true, 
            description: 'Run api test'
        )
        booleanParam(
            name: 'RUN_CAESAR_CIPHER_DECRYPTION', 
            defaultValue: true, 
            description: 'Run Caesar Cipher decryption test'
        )
        booleanParam(
            name: 'RUN_CHECK_DUPLICATE', 
            defaultValue: true, 
            description: 'Run check duplicate list test'
        )
        string(
            name: 'TAGS', 
            defaultValue: '', 
            description: 'Robot Framework tags to filter tests (e.g., Smoke, P0)'
        )
    }
    
    environment {
        REPO_URL = 'https://github.com/Phatsawit-T/robot_Phatsawit.git'
        RESULTS_DIR = "results/${BUILD_TIMESTAMP}"
        SCRIPTS_DIR = 'src/scripts'
        REQUIREMENTS_FILE = 'requirements.txt'
        PYTHON_VERSION = '3.10'
        BUILD_TIMESTAMP = new Date().format('yyyy-MM-dd_HH-mm-ss')
    }
    
    stages {
        stage('Checkout Code From Git') {
            steps {
                checkout scm
            }
        }
        
        stage('Run Tests') {
            steps {
                script {
                    def testFiles = []
                    def tagOption = params.TAGS ? "--include ${params.TAGS}" : ""
                    
                    // เพิ่มไฟล์ test ตาม checkbox ที่เลือก
                    if (params.RUN_WEB_TESTS) {
                        testFiles.add("${SCRIPTS_DIR}/login_test_web.robot")
                    }
                    
                    if (params.RUN_API_TESTS) {
                        testFiles.add("${SCRIPTS_DIR}/api_testing.robot")
                    }
                    
                    if (params.RUN_CAESAR_CIPHER_DECRYPTION) {
                        testFiles.add("${SCRIPTS_DIR}/couterclockwise_direction.robot")
                    }
                    
                    if (params.RUN_CHECK_DUPLICATE) {
                        testFiles.add("${SCRIPTS_DIR}/check_dup_item.robot")
                    }
                    
                    if (params.RUN_MOBILE_TESTS) {
                        testFiles.add("${SCRIPTS_DIR}/mobile_testing.robot")
                    }
                    
                    echo "Running ${testFiles.size()} test suite(s)"
                    
                    if (testFiles.size() > 0) {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            bat """
                                robot --name "Automated Test Report" ${tagOption} --outputdir ${RESULTS_DIR} ${testFiles.join(' ')}
                            """
                        }
                    } else {
                        echo "No test files selected"
                    }
                }
            }
        }
        
        stage('Publish Test Results') {
            steps {
                script {
                    // Archive test results
                    archiveArtifacts artifacts: "${RESULTS_DIR}/**/*.html, ${RESULTS_DIR}/**/*.xml", 
                                   allowEmptyArchive: true
                }
            }
        }
    }
    
    post {
        success {
            echo "✅ Tests passed"
        }
        failure {
            echo "❌ Tests failed"
        }
    }
}