/*
 * Test Automation Assignment - Question 5: Jenkins Pipeline for Executing Automated Scripts
 *
 * This Jenkins Pipeline automates the execution of Robot Framework test scripts
 * covering Web, API, and Mobile test automation.
 *
 * Pipeline Stages:
 * 1. Checkout Code From Git  - Pull latest code from GitHub repository
 * 2. Install Dependencies    - Install Python packages and Robot Framework libraries
 * 3. Run Tests in Parallel   - Execute Web, API, and Mobile tests concurrently
 * 4. Publish Test Results    - Archive test results and generate Robot Framework reports
 * 5. Generate Test Report    - Create consolidated test report from all test suites
 *
 * Parameters:
 * - RUN_MOBILE_TESTS: Enable/disable mobile test execution (requires Appium server)
 * - TEST_SUITE: Select which test suite to run (ALL/WEB/API/MOBILE)
 * - TAGS: Filter tests by Robot Framework tags (e.g., Smoke, P0, P1)
 *
 * Repository: https://github.com/Phatsawit-T/robot_Phatsawit.git
 */

pipeline {
    agent any
    
    parameters {
        booleanParam(
            name: 'RUN_MOBILE_TESTS', 
            defaultValue: false, 
            description: 'Run mobile tests (requires Appium server)'
        )
        booleanParam(
            name: 'RUN_WEB_TESTS', 
            defaultValue: true, 
            description: 'Run login test web'
        )
        booleanParam(
            name: 'RUN_API_TESTS', 
            defaultValue: true, 
            description: 'Run api test'
        )
        booleanParam(
            name: 'RUN_CAESAR_CIPHER_DECRYPTION', 
            defaultValue: true, 
            description: 'Run Caesar Cipher decryption test'
        )
        booleanParam(
            name: 'RUN_CHECK_DUPLICATE', 
            defaultValue: true, 
            description: 'Run check duplicate list test'
        )
        string(
            name: 'TAGS', 
            defaultValue: '', 
            description: 'Robot Framework tags to filter tests (e.g., Smoke, P0)'
        )
    }
    
    environment {
        REPO_URL = 'https://github.com/Phatsawit-T/robot_Phatsawit.git'
        RESULTS_DIR = "results/${BUILD_TIMESTAMP}"
        SCRIPTS_DIR = 'src/scripts'
        REQUIREMENTS_FILE = 'requirements.txt'
        PYTHON_VERSION = '3.10'
        BUILD_TIMESTAMP = new Date().format('yyyy-MM-dd_HH-mm-ss')
    }
    
    stages {
        stage('Checkout Code From Git') {
            steps {
                echo "Checking out code from ${REPO_URL}"
                checkout scm
            }
        }
        
        // stage('Install Dependencies') {
        //     steps {
        //         echo "Installing Python dependencies"
        //         bat """
        //             python --version
        //             pip install --upgrade pip
        //             pip install -r ${REQUIREMENTS_FILE}
        //         """
        //     }
        // }
        
        stage('Run Tests') {
            steps {
                echo "Running Robot Framework Tests"
                script {
                    def testFiles = []
                    def tagOption = params.TAGS ? "--include ${params.TAGS}" : ""
                    
                    // เพิ่มไฟล์ test ตาม checkbox ที่เลือก
                    if (params.RUN_WEB_TESTS) {
                        testFiles.add("${SCRIPTS_DIR}/login_test_web.robot")
                        echo "✓ Selected: Web Login Tests"
                    }
                    
                    if (params.RUN_API_TESTS) {
                        testFiles.add("${SCRIPTS_DIR}/api_testing.robot")
                        echo "✓ Selected: API Tests"
                    }
                    
                    if (params.RUN_CAESAR_CIPHER_DECRYPTION) {
                        testFiles.add("${SCRIPTS_DIR}/couterclockwise_direction.robot")
                        echo "✓ Selected: Caesar Cipher Decryption Tests"
                    }
                    
                    if (params.RUN_CHECK_DUPLICATE) {
                        testFiles.add("${SCRIPTS_DIR}/check_dup_item.robot")
                        echo "✓ Selected: Check Duplicate Tests"
                    }
                    
                    if (params.RUN_MOBILE_TESTS) {
                        testFiles.add("${SCRIPTS_DIR}/mobile_testing.robot")
                        echo "✓ Selected: Mobile Tests"
                    }
                    
                    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
                    echo "Total test files: ${testFiles.size()}"
                    echo "Files: ${testFiles.join(', ')}"
                    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
                    
                    if (testFiles.size() > 0) {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            bat """
                                robot --name "Automated Test Report" ${tagOption} --outputdir ${RESULTS_DIR} ${testFiles.join(' ')}
                            """
                        }
                    } else {
                        echo "⚠️  WARNING: No test files selected!"
                    }
                }
            }
        }
        
        stage('Publish Test Results') {
            steps {
                echo "Publishing test results"
                script {
                    // Archive test results
                    archiveArtifacts artifacts: "${RESULTS_DIR}/**/*.html, ${RESULTS_DIR}/**/*.xml", 
                                   allowEmptyArchive: true
                }
            }
        }
    }
    
    post {
        always {
            echo "Pipeline execution completed"
        }
        success {
            echo "✅ All tests passed successfully!"
        }
        failure {
            echo "❌ Some tests failed. Check the results."
        }
        unstable {
            echo "⚠️ Tests completed with warnings or some failures."
        }
    }
}